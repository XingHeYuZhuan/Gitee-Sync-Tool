name: Gitee Sync (Manual Batch)

on:
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

env:
  GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
  GITEE_OWNER: ${{ vars.GITEE_OWNER }}
  GITEE_REPO: ${{ vars.GITEE_REPO }}
  GITEE_TARGET_COMMITISH: ${{ vars.GITEE_TARGET_COMMITISH }}
  
  # è¢«åŒæ­¥çš„ GitHub ä»“åº“ä¿¡æ¯
  SOURCE_GH_OWNER: ${{ vars.SOURCE_GH_OWNER }}
  SOURCE_GH_REPO_NAME: ${{ vars.SOURCE_GH_REPO_NAME }}

jobs:
  sync-all-unsynced:
    runs-on: ubuntu-latest

    steps:
    - name: Set up dependencies
      run: |
        sudo apt-get update
        # å®‰è£… jq å’Œ parallel (ç”¨äºé™„ä»¶å¹¶è¡Œä¸Šä¼ )
        sudo apt-get install -y jq parallel
      shell: bash

    - name: é˜¶æ®µä¸€ï¼šè¯†åˆ«æœªåŒæ­¥ç‰ˆæœ¬å¹¶æŒ‰åºåˆ›å»º Gitee Release
      id: creation_phase
      run: |
        SOURCE_GH_FULL_REPO="${SOURCE_GH_OWNER}/${SOURCE_GH_REPO_NAME}"
        
        # è·å– Gitee å·²æœ‰çš„ Release æ ‡ç­¾
        GITEE_TAGS=$(curl -s -X GET "https://gitee.com/com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases?access_token=${GITEE_TOKEN}&per_page=100" | jq -r '.[].tag_name')
        
        declare -A SYNCED_TAG_MAP
        while IFS= read -r TAG; do
            SYNCED_TAG_MAP["$TAG"]=1
        done <<< "$GITEE_TAGS"

        # è·å– GitHub Release åˆ—è¡¨
        GH_RELEASES_JSON=$(curl -sL \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "${GITHUB_API_URL}/repos/${SOURCE_GH_FULL_REPO}/releases?per_page=100")

        # ğŸš¨ å…³é”®ï¼šä½¿ç”¨ jq 'reverse' å°†æ ‡ç­¾æŒ‰åˆ›å»ºæ—¶é—´ä»æœ€æ—§åˆ°æœ€æ–°æ’åº
        TAGS_TO_SYNC=()
        while IFS= read -r TAG; do
            if [[ -z "${SYNCED_TAG_MAP[$TAG]}" ]]; then
                TAGS_TO_SYNC+=("$TAG")
            fi
        done < <(echo "$GH_RELEASES_JSON" | jq -r 'reverse | .[] | .tag_name')

        if [ ${#TAGS_TO_SYNC[@]} -eq 0 ]; then
            echo "âœ… æ‰€æœ‰ Release å‡å·²åŒæ­¥ï¼Œæ— éœ€æ“ä½œã€‚"
            echo "metadata_file=SKIP" >> $GITHUB_OUTPUT
            exit 0
        fi
        
        echo "--- å‘ç°æœªåŒæ­¥æ ‡ç­¾ (ä»æ—§åˆ°æ–°): ${#TAGS_TO_SYNC[@]} ä¸ª ---"
        printf "%s\n" "${TAGS_TO_SYNC[@]}"
        
        METADATA_FILE="RELEASE_METADATA.jsonl"
        rm -f "$METADATA_FILE"

        # ä¾æ¬¡åˆ›å»º Gitee Release (ä¿è¯å†å²é¡ºåº)
        for TAG in "${TAGS_TO_SYNC[@]}"; do
          echo "-> æ­£åœ¨åˆ›å»ºæ ‡ç­¾: $TAG"
          
          RELEASE_INFO=$(curl -sL \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "${GITHUB_API_URL}/repos/${SOURCE_GH_FULL_REPO}/releases/tags/${TAG}")

          tag_name=$(echo "$RELEASE_INFO" | jq -r '.tag_name')
          name=$(echo "$RELEASE_INFO" | jq -r '.name')
          body=$(echo "$RELEASE_INFO" | jq -r '.body')
          html_url=$(echo "$RELEASE_INFO" | jq -r '.html_url')
          prerelease=$(echo "$RELEASE_INFO" | jq -r '.prerelease')
          
          RELEASE_BODY="${body} \
          GitHub Release: ${html_url}"
          
          RESPONSE=$(curl -s -X POST "https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases" \
            -d "access_token=${GITEE_TOKEN}" \
            -d "tag_name=${tag_name}" \
            -d "name=${name}" \
            -d "body=${RELEASE_BODY}" \
            -d "prerelease=${prerelease}" \
            -d "target_commitish=${GITEE_TARGET_COMMITISH}")

          release_id=$(echo "$RESPONSE" | jq -r '.id')
          if [ "$release_id" == "null" ]; then
              echo "::error::Gitee Release åˆ›å»ºå¤±è´¥ (${tag_name})ï¼Œå“åº”ï¼š$RESPONSE"
              continue
          fi
          
          ASSET_URLS=$(echo "$RELEASE_INFO" | jq -r '[.assets[] | .browser_download_url] | join("|")')
          
          # å°†å…ƒæ•°æ®å†™å…¥æ–‡ä»¶ä¾›ä¸‹ä¸€é˜¶æ®µå¹¶è¡Œä½¿ç”¨
          jq -n \
            --arg tag "$tag_name" \
            --arg id "$release_id" \
            --arg urls "$ASSET_URLS" \
            '{tag_name: $tag, gitee_id: $id, asset_urls: $urls}' >> "$METADATA_FILE"
          
          echo "åˆ›å»ºæˆåŠŸï¼ŒID: $release_id"
        done
        
        echo "metadata_file=$METADATA_FILE" >> $GITHUB_OUTPUT
      shell: bash

    - name: é˜¶æ®µäºŒï¼šå¹¶è¡Œä¸‹è½½å’Œä¸Šä¼ é™„ä»¶
      if: steps.creation_phase.outputs.metadata_file != 'SKIP'
      run: |
        METADATA_FILE="${{ steps.creation_phase.outputs.metadata_file }}"
        
        sync_assets() {
            local METADATA="$1"
            local TAG_NAME=$(echo "$METADATA" | jq -r '.tag_name')
            local RELEASE_ID=$(echo "$METADATA" | jq -r '.gitee_id')
            local ASSET_URLS=$(echo "$METADATA" | jq -r '.asset_urls')
            local TEMP_DIR="assets_${TAG_NAME}"
            
            echo "--- å¼€å§‹åŒæ­¥ ${TAG_NAME} (ID: ${RELEASE_ID}) çš„é™„ä»¶ ---" >&2
            
            # 1. ä¸‹è½½é™„ä»¶
            mkdir -p "${TEMP_DIR}"
            echo "$ASSET_URLS" | tr '|' '\n' | while IFS= read -r ASSET_URL; do
                if [ -z "$ASSET_URL" ]; then continue; fi
                local FNAME=$(basename "$ASSET_URL")
                echo "Downloading $FNAME..." >&2
                # ä¸‹è½½æ—¶ä½¿ç”¨ GitHub Token è®¤è¯
                curl -L -o "${TEMP_DIR}/${FNAME}" -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "$ASSET_URL"
            done
            
            # 2. ä¸Šä¼ é™„ä»¶
            upload_file() {
              local FILE="$1"
              echo "Uploading $FILE..." >&2
              # ä½¿ç”¨å…¨å±€ç¯å¢ƒå˜é‡
              curl -s -X POST "https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases/${RELEASE_ID}/attach_files" \
                -F "access_token=${GITEE_TOKEN}" \
                -F "file=@${FILE}" > /dev/null
            }
            export -f upload_file
            
            # ä½¿ç”¨ GNU parallel å¯¹è¯¥ Release çš„æ‰€æœ‰é™„ä»¶è¿›è¡Œå¹¶è¡Œä¸Šä¼ 
            find "${TEMP_DIR}" -type f | parallel -j 5 upload_file
            
            # 3. æ¸…ç†
            rm -rf "${TEMP_DIR}"
            echo "--- ${TAG_NAME} é™„ä»¶åŒæ­¥å®Œæˆ ---" >&2
        }
        export -f sync_assets

        # å¯¼å‡ºå…¨å±€å˜é‡ä¾› parallel çš„å­ shell ä½¿ç”¨
        export GITEE_TOKEN=${GITEE_TOKEN}
        export GITEE_OWNER=${GITEE_OWNER}
        export GITEE_REPO=${GITEE_REPO}

        echo "--- å¯åŠ¨é™„ä»¶å¹¶è¡ŒåŒæ­¥ ---"
        # å…³é”®ï¼šä½¿ç”¨ parallel å¹¶è¡Œå¤„ç†å¤šä¸ª Release çš„é™„ä»¶åŒæ­¥ä»»åŠ¡
        cat "$METADATA_FILE" | parallel -j 5 sync_assets "{}"
        
        echo "æ‰€æœ‰é™„ä»¶åŒæ­¥å®Œæˆã€‚"
      shell: bash