name: Gitee Sync (Manual Batch)

on:
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

env:
  GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
  GITEE_OWNER: ${{ vars.GITEE_OWNER }}
  GITEE_REPO: ${{ vars.GITEE_REPO }}
  GITEE_TARGET_COMMITISH: ${{ vars.GITEE_TARGET_COMMITISH }}
  
  # è¢«åŒæ­¥çš„ GitHub ä»“åº“ä¿¡æ¯
  SOURCE_GH_OWNER: ${{ vars.SOURCE_GH_OWNER }}
  SOURCE_GH_REPO_NAME: ${{ vars.SOURCE_GH_REPO_NAME }}

jobs:
  sync-all-unsynced:
    runs-on: ubuntu-latest

    steps:
    - name: Set up dependencies
      run: |
        sudo apt-get update
        # å®‰è£… jq å’Œ parallel (ç”¨äºé™„ä»¶å¹¶è¡Œä¸Šä¼ )
        sudo apt-get install -y jq parallel
      shell: bash

    - name: é˜¶æ®µä¸€ï¼šè¯†åˆ«å¹¶åˆ›å»º/æ›´æ–° Gitee Release
      id: creation_phase
      run: |
        SOURCE_GH_FULL_REPO="${SOURCE_GH_OWNER}/${SOURCE_GH_REPO_NAME}"
        
        # è·å– Gitee å·²æœ‰çš„ Release æ ‡ç­¾å’Œ ID
        GITEE_RELEASES=$(curl -s -X GET "https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases?access_token=${GITEE_TOKEN}&per_page=100" | jq -r '.[].tag_name') 
        
        declare -A SYNCED_TAG_MAP
        # å»ºç«‹æ ‡ç­¾åˆ° Gitee Release ID çš„æ˜ å°„ (é‡æ–°æå–æ‰€æœ‰ä¿¡æ¯ï¼Œé¿å…è§£æé—®é¢˜)
        while IFS= read -r line; do
          TAG=$(echo "$line" | cut -d':' -f1)
          ID=$(echo "$line" | cut -d':' -f2)
          TAG=$(echo "$TAG" | xargs)
          if [ -n "$TAG" ]; then
            SYNCED_TAG_MAP["$TAG"]="$ID"
          fi
        done < <(curl -s -X GET "https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases?access_token=${GITEE_TOKEN}&per_page=100" | jq -r '.[] | "\(.tag_name):\(.id)"' | tr -d '\r')

        # è·å– GitHub Release åˆ—è¡¨
        GH_RELEASES_JSON=$(curl -sL \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "${GITHUB_API_URL}/repos/${SOURCE_GH_FULL_REPO}/releases?per_page=100")

        # ğŸš¨ å…³é”®ï¼šä½¿ç”¨ jq 'reverse' å°†æ ‡ç­¾æŒ‰åˆ›å»ºæ—¶é—´ä»æœ€æ—§åˆ°æœ€æ–°æ’åº
        TAGS_TO_PROCESS=()
        while IFS= read -r TAG; do
            TAGS_TO_PROCESS+=("$TAG")
        done < <(echo "$GH_RELEASES_JSON" | jq -r 'reverse | .[] | .tag_name')

        if [ ${#TAGS_TO_PROCESS[@]} -eq 0 ]; then
            echo "âœ… ç›®æ ‡ GitHub ä»“åº“æ²¡æœ‰ Releaseã€‚"
            echo "metadata_file=SKIP" >> $GITHUB_OUTPUT
            exit 0
        fi
        
        echo "--- å‘ç°å¾…å¤„ç†æ ‡ç­¾ (ä»æ—§åˆ°æ–°): ${#TAGS_TO_PROCESS[@]} ä¸ª ---"
        printf "%s\n" "${TAGS_TO_PROCESS[@]}"
        
        METADATA_FILE="RELEASE_METADATA.jsonl"
        rm -f "$METADATA_FILE"

        # ä¾æ¬¡åˆ›å»º/æ›´æ–° Gitee Release (ä¿è¯å†å²é¡ºåº)
        for TAG in "${TAGS_TO_PROCESS[@]}"; do
          echo "-> æ­£åœ¨å¤„ç†æ ‡ç­¾: $TAG"
          
          RELEASE_INFO=$(echo "$GH_RELEASES_JSON" | jq -c ".[] | select(.tag_name == \"${TAG}\")")
          
          tag_name=$(echo "$RELEASE_INFO" | jq -r '.tag_name')
          name=$(echo "$RELEASE_INFO" | jq -r '.name')
          body=$(echo "$RELEASE_INFO" | jq -r '.body')
          html_url=$(echo "$RELEASE_INFO" | jq -r '.html_url')
          prerelease=$(echo "$RELEASE_INFO" | jq -r '.prerelease')
          
          RELEASE_BODY="${body}"
          
          GITEE_RELEASE_ID="${SYNCED_TAG_MAP[$TAG]}"

          if [ -z "$GITEE_RELEASE_ID" ]; then
              # --- 1. åˆ›å»º Release ---
              echo "-> æ ‡ç­¾ $TAG å°šæœªåŒæ­¥ï¼Œæ­£åœ¨åˆ›å»º Release..."
              RESPONSE=$(curl -s -X POST "https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases" \
                -d "access_token=${GITEE_TOKEN}" \
                -d "tag_name=${tag_name}" \
                -d "name=${name}" \
                -d "body=${RELEASE_BODY}" \
                -d "prerelease=${prerelease}" \
                -d "target_commitish=${GITEE_TARGET_COMMITISH}")
                
              release_id=$(echo "$RESPONSE" | jq -r '.id')
              if [ "$release_id" == "null" ]; then
                  echo "::error::Gitee Release åˆ›å»ºå¤±è´¥ (${tag_name})ï¼Œå“åº”ï¼š$RESPONSE"
                  continue
              fi
              echo "åˆ›å»ºæˆåŠŸï¼ŒID: $release_id"
              GITEE_RELEASE_ID="$release_id"
          else
              # --- 2. æ›´æ–° Release (åç§°å’Œæè¿°) ---
              echo "-> æ ‡ç­¾ $TAG å·²åŒæ­¥ (ID: ${GITEE_RELEASE_ID})ï¼Œæ­£åœ¨æ›´æ–°æè¿°/åç§°..."
              RESPONSE=$(curl -s -X PATCH "https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases/${GITEE_RELEASE_ID}" \
                -d "access_token=${GITEE_TOKEN}" \
                -d "tag_name=${tag_name}" \
                -d "name=${name}" \
                -d "body=${RELEASE_BODY}")
              
              if ! echo "$RESPONSE" | jq -e '.id' > /dev/null; then
                  echo "::error::Gitee Release æ›´æ–°å¤±è´¥ (${tag_name})ï¼Œå“åº”ï¼š$RESPONSE"
                  continue
              fi
              echo "æ›´æ–°æˆåŠŸï¼ŒID: $GITEE_RELEASE_ID"
          fi
          
          # é™„ä»¶ URL åˆ—è¡¨ (ç”¨ "|" è¿æ¥)
          ASSET_URLS=$(echo "$RELEASE_INFO" | jq -r '[.assets[] | .browser_download_url] | join("|")')
          
          # å°†å…ƒæ•°æ®å†™å…¥æ–‡ä»¶ä¾›ä¸‹ä¸€é˜¶æ®µå¹¶è¡Œä½¿ç”¨
          # ğŸš¨ ä¿®æ­£ï¼šä½¿ç”¨ -c é€‰é¡¹å¼ºåˆ¶è¾“å‡ºç´§å‡‘çš„å•è¡Œ JSON
          jq -n -c \
            --arg tag "$tag_name" \
            --arg id "$GITEE_RELEASE_ID" \
            --arg urls "$ASSET_URLS" \
            '{tag_name: $tag, gitee_id: $id, asset_urls: $urls}' >> "$METADATA_FILE"
          
        done
        
        echo "metadata_file=$METADATA_FILE" >> $GITHUB_OUTPUT
      shell: bash

    - name: é˜¶æ®µäºŒï¼šä¸²è¡Œä¸‹è½½å’Œä¸Šä¼ é™„ä»¶ (è°ƒè¯•æ¨¡å¼)
      if: steps.creation_phase.outputs.metadata_file != 'SKIP'
      run: |
        METADATA_FILE="${{ steps.creation_phase.outputs.metadata_file }}"
        
        sync_assets() {
            local METADATA="$1"
            
            # å¢åŠ å¯¹å…ƒæ•°æ®å‚æ•°çš„æ¸…ç†ï¼Œä»¥é˜²ä¸‡ä¸€
            # ä¸²è¡Œæ¨¡å¼ä¸‹ä¸éœ€è¦å¤ªå¤šæ¸…ç†ï¼Œä½†ä¿ç•™ä»¥ç¡®ä¿å¥å£®æ€§
            local CLEAN_METADATA=$(echo "$METADATA" | tr -d '\r' | grep -v '^\s*$' | tr -d '\n')
            
            export TAG_NAME=$(echo "$CLEAN_METADATA" | jq -r '.tag_name')
            export RELEASE_ID=$(echo "$CLEAN_METADATA" | jq -r '.gitee_id')
            local ASSET_URLS=$(echo "$CLEAN_METADATA" | jq -r '.asset_urls')
            local TEMP_DIR="assets_${TAG_NAME}"
            
            # å¢åŠ ä¸€ä¸ªæ£€æŸ¥ï¼Œç¡®ä¿ ID å’Œ TAG å·²ç»æ­£ç¡®è§£æ
            if [ -z "$RELEASE_ID" ] || [ "$RELEASE_ID" == "null" ]; then
                echo "::error::è§£æ Release ID å¤±è´¥ï¼Œè·³è¿‡åŒæ­¥ã€‚åŸå§‹å…ƒæ•°æ®: $CLEAN_METADATA" >&2
                return 1
            fi
            
            echo "--- å¼€å§‹åŒæ­¥ ${TAG_NAME} (ID: ${RELEASE_ID}) çš„é™„ä»¶ ---" >&2
            
            # --- 0. è¦†ç›–é€»è¾‘ï¼šå…ˆåˆ é™¤ Gitee ä¸Šçš„æ—§é™„ä»¶ ---
            echo "æ­£åœ¨æ¸…ç† Gitee æ—§é™„ä»¶..." >&2
            GITEE_ASSETS=$(curl -s -X GET "https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases/${RELEASE_ID}/attach_files?access_token=${GITEE_TOKEN}")
            
            # ä½¿ç”¨æ›´å®‰å…¨çš„ jq è§£ææ¥åˆ¤æ–­æ˜¯å¦ä¸ºç©ºæ•°ç»„
            if echo "$GITEE_ASSETS" | jq -e '. | type == "array" and length > 0' > /dev/null; then
                echo "$GITEE_ASSETS" | jq -r '.[].id' | while IFS= read -r ASSET_ID; do
                    # ä½¿ç”¨ -s é™é»˜æ¨¡å¼ï¼Œåªå…³æ³¨è¿”å›ç 
                    curl -s -X DELETE "https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases/${RELEASE_ID}/attach_files/${ASSET_ID}?access_token=${GITEE_TOKEN}" > /dev/null
                done
                echo "æ—§é™„ä»¶æ¸…ç†å®Œæˆã€‚" >&2
            else
                echo "Gitee ä¸Šæ— æ—§é™„ä»¶éœ€è¦æ¸…ç†ã€‚" >&2
            fi

            # 1. ä¸‹è½½é™„ä»¶
            mkdir -p "${TEMP_DIR}"
            if [ -z "$ASSET_URLS" ] || [ "$ASSET_URLS" == "null" ]; then
                echo "GitHub Release æ²¡æœ‰é™„ä»¶ï¼Œè·³è¿‡ä¸‹è½½/ä¸Šä¼ ã€‚" >&2
            else
                echo "$ASSET_URLS" | tr '|' '\n' | while IFS= read -r ASSET_URL; do
                    if [ -z "$ASSET_URL" ]; then continue; fi
                    local FNAME=$(basename "$ASSET_URL")
                    echo "Downloading $FNAME..." >&2
                    # ä½¿ç”¨å¯¼å‡ºçš„ç¯å¢ƒå˜é‡ GITHUB_TOKEN
                    curl -L -o "${TEMP_DIR}/${FNAME}" -H "Authorization: token ${GITHUB_TOKEN}" "$ASSET_URL"
                done
                
                # 2. ä¸Šä¼ é™„ä»¶
                # è¿™é‡Œä¸ä½¿ç”¨ upload_file å­å‡½æ•°å’Œ parallelï¼Œè€Œæ˜¯ä½¿ç”¨ find å’Œ while ä¸²è¡Œä¸Šä¼ 
                find "${TEMP_DIR}" -type f | while IFS= read -r FILE; do
                    echo "Uploading $FILE..." >&2
                    RESPONSE=$(curl -s -X POST "https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases/${RELEASE_ID}/attach_files" \
                      -F "access_token=${GITEE_TOKEN}" \
                      -F "file=@${FILE}")
                    
                    if echo "$RESPONSE" | grep -q '"message"'; then
                        echo "::warning::é™„ä»¶ä¸Šä¼ å¤±è´¥ ($FILE)ï¼Œå“åº”ï¼š$RESPONSE" >&2
                    fi
                done
            fi
            
            # 3. æ¸…ç†
            rm -rf "${TEMP_DIR}"
            echo "--- ${TAG_NAME} é™„ä»¶åŒæ­¥å®Œæˆ ---" >&2
        }
        # ğŸš¨ ä¸²è¡Œæ¨¡å¼ä¸‹ï¼Œä¸éœ€è¦å¯¼å‡º sync_assets å‡½æ•°ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯ç›´æ¥åœ¨ä¸» Shell ä¸­è°ƒç”¨å®ƒã€‚

        # å¯¼å‡ºå…¨å±€å˜é‡
        export GITEE_TOKEN=${GITEE_TOKEN}
        export GITEE_OWNER=${GITEE_OWNER}
        export GITEE_REPO=${GITEE_REPO}
        export GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }} # ä¿æŒå¯¼å‡º

        echo "--- å¯åŠ¨é™„ä»¶ä¸²è¡ŒåŒæ­¥ (è°ƒè¯•æ¨¡å¼) ---"
        
        # ğŸš¨ å…³é”®ä¿®æ”¹ï¼šåˆ‡æ¢åˆ° while read å¾ªç¯ï¼Œå¼ºåˆ¶ä¸²è¡Œæ‰§è¡Œï¼Œç¡®ä¿å®æ—¶è¾“å‡º
        cat "$METADATA_FILE" | tr -d '\r' | grep . | while IFS= read -r METADATA_LINE; do
            sync_assets "$METADATA_LINE"
        done
        
        echo "æ‰€æœ‰é™„ä»¶åŒæ­¥å®Œæˆã€‚"
      shell: bash
